{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load music_extras %}

{% block title %}Треки - Музыкальный сервис{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1>Треки</h1>
            <a href="{% url 'music:track_upload' %}" class="btn btn-primary">
                <i class="fas fa-upload"></i> Загрузить трек
            </a>
        </div>
    </div>

    <div class="tracks-container">
        {% for track in tracks %}
        <div class="track-item list-group-item" 
             data-track-id="{{ track.pk }}"
             data-audio-url="{{ track.audio_file.url }}"
             data-title="{{ track.title }}"
             data-artist="{{ track.artist }}"
             data-cover="{% if track.cover %}{{ track.cover.url }}{% else %}https://via.placeholder.com/50{% endif %}">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="play-button me-3">
                        <i class="fas fa-play"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">{{ track.title }}</h5>
                        <p class="mb-1">{{ track.artist }}</p>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <a href="{% url 'music:track_detail' track.pk %}" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-info-circle"></i>
                    </a>
                    <a href="{% url 'music:generate_qr' track.pk %}" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-qrcode"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-success me-2 add-to-playlist-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Аудиоплеер -->
<div id="player" style="display: none;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <!-- Информация о треке -->
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <img id="playerCover" src="" alt="Track cover" class="me-3" style="width: 48px; height: 48px; border-radius: 4px;">
                    <div class="track-info">
                        <div id="playerTitle" class="text-white" style="font-size: 0.95rem; font-weight: 500;"></div>
                        <div id="playerArtist" class="text-white-50" style="font-size: 0.85rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Управление воспроизведением -->
            <div class="col-md-6">
                <div class="d-flex flex-column align-items-center">
                    <!-- Кнопки управления -->
                    <div class="control-buttons mb-2">
                        <button id="prevButton" class="btn btn-link text-white mx-2" style="opacity: 0.7;">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button id="playPauseButton" class="btn btn-link text-white mx-3">
                            <i id="playPauseIcon" class="fas fa-play fa-lg"></i>
                        </button>
                        <button id="nextButton" class="btn btn-link text-white mx-2" style="opacity: 0.7;">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button id="shuffleButton" class="btn btn-link text-white mx-2" style="opacity: 0.7;">
                            <i class="fas fa-random"></i>
                        </button>
                        <button id="repeatButton" class="btn btn-link text-white mx-2" style="opacity: 0.7;">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </div>
                    
                    <!-- Прогресс-бар -->
                    <div class="progress-container d-flex align-items-center w-100">
                        <span id="currentTime" class="text-white-50 me-2">0:00</span>
                        <div class="progress flex-grow-1">
                            <div class="progress-bar" role="progressbar"></div>
                        </div>
                        <span id="duration" class="text-white-50 ms-2">0:00</span>
                    </div>
                </div>
            </div>

            <!-- Управление громкостью -->
            <div class="col-md-3">
                <div class="d-flex align-items-center justify-content-end">
                    <button id="volumeButton" class="btn btn-link text-white me-2" style="opacity: 0.7;">
                        <i id="volumeIcon" class="fas fa-volume-up"></i>
                    </button>
                    <div class="volume-slider" style="width: 100px;">
                        <input type="range" class="form-range" id="volumeRange" min="0" max="100" value="100">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <audio id="audioPlayer"></audio>
</div>

<!-- Модальное окно для выбора плейлиста -->
<div class="modal fade" id="playlistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #282828; color: white;">
            <div class="modal-header border-0">
                <h5 class="modal-title">Добавить в плейлист</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="playlistsList" class="list-group list-group-flush">
                    {% for playlist in user_playlists %}
                    <button type="button" class="list-group-item list-group-item-action bg-transparent text-white border-light playlist-select-btn" 
                            data-playlist-id="{{ playlist.pk }}">
                        {{ playlist.name }}
                    </button>
                    {% endfor %}
                    <a href="{% url 'music:playlist_create' %}" class="list-group-item list-group-item-action bg-transparent text-white border-light">
                        <i class="fas fa-plus"></i> Создать новый плейлист
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tracks-container {
    margin-bottom: 90px;
}

.track-item {
    background-color: #282828;
    border-radius: 4px;
    margin-bottom: 8px;
    padding: 12px;
    border: none;
}

.track-item:hover {
    background-color: #333333;
}

.track-item h5 {
    color: #fff !important;
    font-size: 1rem;
    margin-bottom: 4px !important;
}

.track-item p {
    color: #b3b3b3 !important;
    font-size: 0.9rem;
    margin-bottom: 4px !important;
}

.play-button {
    width: 36px;
    height: 36px;
    min-width: 36px;
    border-radius: 50%;
    background-color: #1db954;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
}

.play-button:hover {
    transform: scale(1.1);
    background-color: #1ed760;
}

/* Стили для кнопок действий */
.track-item .btn-sm {
    padding: 4px 8px;
    font-size: 0.9rem;
    background-color: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
}

.track-item .btn-sm:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* Стили плеера */
#player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #282828;
    border-top: 1px solid #404040;
    padding: 8px 0;
    z-index: 1000;
}

.progress {
    background-color: #535353;
    height: 4px;
    border-radius: 2px;
    cursor: pointer;
    position: relative;
    margin: 0 8px;
    overflow: visible !important;
}

.progress-bar {
    background-color: #1db954;
    height: 100%;
    border-radius: 2px;
    position: relative;
    transition: width 0.1s linear;
}

.progress-bar::after {
    content: '';
    position: absolute;
    right: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    background-color: #fff;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
}

.progress:hover .progress-bar::after,
.progress.dragging .progress-bar::after {
    opacity: 1;
}

.control-buttons button {
    opacity: 0.7;
    transition: all 0.2s ease;
}

.control-buttons button:hover {
    opacity: 1;
    transform: scale(1.1);
}

.control-buttons button.active {
    opacity: 1;
    color: #1db954 !important;
}

/* Медиа-запросы для адаптивности */
@media (max-width: 768px) {
    .track-item {
        padding: 10px;
    }

    .track-item h5 {
        font-size: 0.95rem;
    }

    .track-item p {
        font-size: 0.85rem;
    }

    .play-button {
        width: 32px;
        height: 32px;
        min-width: 32px;
    }
}
</style>

<script>
let currentTrackId = null;
let playlist = [];
let currentPlaylistIndex = -1;
let isShuffleEnabled = false;
let repeatMode = 'none';
let isDragging = false;
let progressContainer = null;
let progressBar = null;

function initializePlaylist() {
    // Собираем все треки в плейлист
    playlist = Array.from(document.querySelectorAll('.track-item')).map(track => ({
        id: track.dataset.trackId,
        url: track.dataset.audioUrl,
        title: track.dataset.title,
        artist: track.dataset.artist,
        cover: track.dataset.cover
    }));
}

function incrementPlayCount(trackId) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/tracks/${trackId}/increment-play-count/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        const playCountElement = document.querySelector(`[data-track-id="${trackId}"] .play-count`);
        if (playCountElement) {
            playCountElement.innerHTML = `<i class="fas fa-play"></i> ${data.play_count}`;
        }
    })
    .catch(error => console.error('Error:', error));
}

function setupAudioPlayer() {
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseButton = document.getElementById('playPauseButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const shuffleButton = document.getElementById('shuffleButton');
    const repeatButton = document.getElementById('repeatButton');
    const volumeRange = document.getElementById('volumeRange');
    const volumeButton = document.getElementById('volumeButton');
    
    // Инициализируем глобальные переменные для прогресс-бара
    progressContainer = document.querySelector('.progress');
    progressBar = document.querySelector('.progress-bar');

    // Инициализация плейлиста
    initializePlaylist();

    // Обработчики событий для аудиоплеера
    audioPlayer.addEventListener('timeupdate', () => {
        if (!isDragging) {
            updateProgress();
        }
    });
    audioPlayer.addEventListener('ended', handleTrackEnd);
    audioPlayer.addEventListener('loadedmetadata', () => {
        document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
    });

    // Обработчики для кнопок управления
    playPauseButton.addEventListener('click', togglePlay);
    prevButton.addEventListener('click', playPreviousTrack);
    nextButton.addEventListener('click', playNextTrack);
    shuffleButton.addEventListener('click', toggleShuffle);
    repeatButton.addEventListener('click', toggleRepeat);
    volumeButton.addEventListener('click', toggleMute);
    volumeRange.addEventListener('input', (e) => {
        audioPlayer.volume = e.target.value / 100;
        updateVolumeIcon();
    });

    // Начальная установка громкости
    audioPlayer.volume = volumeRange.value / 100;

    // Обработчики для прогресс-бара
    progressContainer.addEventListener('mousedown', startDragging);
    document.addEventListener('mousemove', handleDrag);
    document.addEventListener('mouseup', stopDragging);
    progressContainer.addEventListener('mouseleave', stopDragging);
    progressContainer.addEventListener('click', handleProgressClick);
}

function togglePlay() {
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseIcon = document.getElementById('playPauseIcon');
    
    if (audioPlayer.paused) {
        audioPlayer.play().then(() => {
            playPauseIcon.classList.replace('fa-play', 'fa-pause');
            updatePlayButtonIcon(currentTrackId, true);
        });
    } else {
        audioPlayer.pause();
        playPauseIcon.classList.replace('fa-pause', 'fa-play');
        updatePlayButtonIcon(currentTrackId, false);
    }
}

function updatePlayButtonIcon(trackId, isPlaying) {
    const button = document.querySelector(`[data-track-id="${trackId}"] .play-button i`);
    if (button) {
        button.classList.replace(isPlaying ? 'fa-play' : 'fa-pause', 
                               isPlaying ? 'fa-pause' : 'fa-play');
    }
}

function toggleShuffle() {
    isShuffleEnabled = !isShuffleEnabled;
    const shuffleButton = document.getElementById('shuffleButton');
    shuffleButton.classList.toggle('active', isShuffleEnabled);
}

function toggleRepeat() {
    const repeatButton = document.getElementById('repeatButton');
    
    // Переключаем между двумя состояниями: выключено и включено
    if (repeatMode === 'none') {
        // Включаем режим повтора
        repeatMode = 'all';
        repeatButton.classList.add('active');
    } else {
        // Выключаем режим повтора
        repeatMode = 'none';
        repeatButton.classList.remove('active');
    }
}

function handleTrackEnd() {
    const audioPlayer = document.getElementById('audioPlayer');
    
    if (repeatMode === 'all') {
        // Если включен режим повтора, начинаем воспроизведение текущего трека заново
        audioPlayer.currentTime = 0;
        audioPlayer.play();
    } else {
        // Если выключен режим повтора
        if (isShuffleEnabled) {
            // Если включен shuffle, играем случайный трек
            playNextTrack();
        } 
        // Если есть следующий трек, играем его
        else if (currentPlaylistIndex < playlist.length - 1) {
            playNextTrack();
        }
    }
}

function updateProgress() {
    const audioPlayer = document.getElementById('audioPlayer');
    const progressBar = document.querySelector('.progress-bar');
    const currentTimeElement = document.getElementById('currentTime');
    
    if (audioPlayer.duration) {
        const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.style.width = `${percent}%`;
        currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
        
        // Обновляем позицию белого кружка
        progressBar.style.setProperty('--progress-position', `${percent}%`);
    }
}

function toggleMute() {
    const audioPlayer = document.getElementById('audioPlayer');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeRange = document.getElementById('volumeRange');
    
        audioPlayer.muted = !audioPlayer.muted;
        updateVolumeIcon();
}

function updateVolumeIcon() {
    const audioPlayer = document.getElementById('audioPlayer');
    const volumeIcon = document.getElementById('volumeIcon');
    
    if (audioPlayer.muted || audioPlayer.volume === 0) {
        volumeIcon.className = 'fas fa-volume-mute';
    } else if (audioPlayer.volume < 0.5) {
        volumeIcon.className = 'fas fa-volume-down';
    } else {
        volumeIcon.className = 'fas fa-volume-up';
    }
}

function playTrack(url, title, artist, cover, trackId) {
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const player = document.getElementById('player');
    
    // Если плейлист еще не инициализирован, инициализируем его
    if (playlist.length === 0) {
        initializePlaylist();
    }
    
    // Если нажали на тот же трек
    if (currentTrackId === trackId) {
        togglePlay();
        return;
    }

    // Сбрасываем все иконки воспроизведения
    document.querySelectorAll('.play-button i').forEach(icon => {
        icon.classList.replace('fa-pause', 'fa-play');
    });
    
    // Обновляем информацию о треке
    audioPlayer.src = url;
    document.getElementById('playerTitle').textContent = title;
    document.getElementById('playerArtist').textContent = artist;
    document.getElementById('playerCover').src = cover;
    player.style.display = 'block';
    
    // Обновляем индекс текущего трека в плейлисте
    currentPlaylistIndex = playlist.findIndex(track => track.id === trackId.toString());
    currentTrackId = trackId;
    
    // Увеличиваем счетчик прослушиваний
    incrementPlayCount(trackId);
    
    // Воспроизводим трек
    audioPlayer.play()
        .then(() => {
            playPauseIcon.classList.replace('fa-play', 'fa-pause');
            // Обновляем иконку на кнопке воспроизведения текущего трека
            const currentTrackButton = document.querySelector(`[data-track-id="${trackId}"] .play-button i`);
            if (currentTrackButton) {
                currentTrackButton.classList.replace('fa-play', 'fa-pause');
            }
        })
        .catch(error => console.error('Error playing audio:', error));
}

// Функция для получения следующего трека
function getNextTrack() {
    if (playlist.length === 0) return null;
    
    if (isShuffleEnabled) {
        return getRandomTrack();
    }

    if (currentPlaylistIndex < playlist.length - 1) {
        return playlist[currentPlaylistIndex + 1];
    } else {
        // Когда достигнут последний трек, возвращаемся к первому
        return playlist[0];
    }
}

// Функция для получения предыдущего трека
function getPrevTrack() {
    if (playlist.length === 0) return null;
    
    if (isShuffleEnabled) {
        return getRandomTrack();
    }

    if (currentPlaylistIndex > 0) {
        return playlist[currentPlaylistIndex - 1];
    } else if (repeatMode === 'all') {
        // Если включен режим повтора всех треков, переходим к последнему треку
        return playlist[playlist.length - 1];
    }
    return null;
}

// Функция для получения случайного трека
function getRandomTrack() {
    if (playlist.length <= 1) return null;
    
    let randomIndex;
    do {
        randomIndex = Math.floor(Math.random() * playlist.length);
    } while (randomIndex === currentPlaylistIndex);
    
    return playlist[randomIndex];
}

// Функция для воспроизведения следующего трека
function playNextTrack() {
    const nextTrack = getNextTrack();
    if (nextTrack) {
        playTrack(nextTrack.url, nextTrack.title, nextTrack.artist, nextTrack.cover, nextTrack.id);
    }
}

// Функция для воспроизведения предыдущего трека
function playPreviousTrack() {
    const prevTrack = getPrevTrack();
    if (prevTrack) {
        playTrack(prevTrack.url, prevTrack.title, prevTrack.artist, prevTrack.cover, prevTrack.id);
    }
}

// Инициализация аудиоплеера
document.addEventListener('DOMContentLoaded', function() {
    setupAudioPlayer();
    
    // Обработчик для кнопок воспроизведения
    document.querySelectorAll('.play-button').forEach(button => {
        button.addEventListener('click', function() {
            const trackItem = this.closest('.track-item');
            if (trackItem) {
                playTrack(
                    trackItem.dataset.audioUrl,
                    trackItem.dataset.title,
                    trackItem.dataset.artist,
                    trackItem.dataset.cover,
                    trackItem.dataset.trackId
                );
            }
        });
    });

    // Обработчики для кнопок управления плеером
    const playPauseButton = document.getElementById('playPauseButton');
    if (playPauseButton) {
        playPauseButton.addEventListener('click', togglePlay);
    }

    const prevButton = document.getElementById('prevButton');
    if (prevButton) {
        prevButton.addEventListener('click', playPreviousTrack);
    }

    const nextButton = document.getElementById('nextButton');
    if (nextButton) {
        nextButton.addEventListener('click', playNextTrack);
    }

    const shuffleButton = document.getElementById('shuffleButton');
    if (shuffleButton) {
        shuffleButton.addEventListener('click', toggleShuffle);
    }

    const repeatButton = document.getElementById('repeatButton');
    if (repeatButton) {
        repeatButton.addEventListener('click', toggleRepeat);
    }

    const volumeButton = document.getElementById('volumeButton');
    if (volumeButton) {
        volumeButton.addEventListener('click', toggleMute);
    }

    const volumeRange = document.getElementById('volumeRange');
    if (volumeRange) {
        volumeRange.addEventListener('input', (e) => {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.volume = e.target.value / 100;
                updateVolumeIcon();
            }
        });
    }
});

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Функция для модального окна плейлистов
function addToPlaylistModal(trackId) {
    currentTrackId = trackId;
    new bootstrap.Modal(document.getElementById('playlistModal')).show();
}

function addToPlaylist(trackId, playlistId) {
    fetch("{% url 'music:add_track_to_playlist' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `track_id=${trackId}&playlist_id=${playlistId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('playlistModal')).hide();
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении трека.');
    });
}

// Автоматический поиск при вводе
const searchForm = document.querySelector('form');
const searchInput = searchForm.querySelector('input[name="q"]');

searchInput.addEventListener('input', function() {
    if (this.value.length >= 2) {
        searchForm.submit();
    }
});

function startDragging(e) {
    isDragging = true;
    progressContainer.classList.add('dragging');
    handleDrag(e);
}

function stopDragging() {
    if (isDragging) {
        isDragging = false;
        progressContainer.classList.remove('dragging');
    }
}

function handleDrag(e) {
    if (isDragging && progressContainer && progressBar) {
        e.preventDefault();
        const rect = progressContainer.getBoundingClientRect();
        const percent = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
        progressBar.style.width = `${percent * 100}%`;
        const audioPlayer = document.getElementById('audioPlayer');
        if (audioPlayer && audioPlayer.duration) {
            audioPlayer.currentTime = percent * audioPlayer.duration;
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        }
    }
}

function handleProgressClick(e) {
    if (progressContainer && progressBar) {
        const rect = progressContainer.getBoundingClientRect();
        const percent = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);
        progressBar.style.width = `${percent * 100}%`;
        const audioPlayer = document.getElementById('audioPlayer');
        if (audioPlayer && audioPlayer.duration) {
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }
    }
}
</script>
{% endblock %} 